# Pre-requisite: Nexpose configuration:

# Site "xad_test_vulnerability_site" and "xad_test_disc_site"               (Tenant ID: 7fd98776-4e8b-49fc-bfc8-fe0464c7321e)
# xad_test_vulnerability_site:  Include: NA                                 Exclude: [10.131.146.13 - 10.131.146.14]
# xad_test_disc_site:           Include: 10.131.146.65 - 10.131.146.126     Exclude: 10.131.146.12


# Site "xad_auto_test_vulnerability_site" and "xad_auto_test_disc_site"     (Tenant ID_2: 59deef16-a618-4ae7-8fed-b3c9050092aa, TENANT_ID_3: ca4a510a-d37c-43fa-822f-e5313a2aece1)
# xad_auto_test_vulnerability_site: Include: [10.131.144.20- 10.131.144.28] ,10.131.146.11 , 10.131.146.13 , .14 , 10.131.146.101 - 10.131.146.111   Exclude: 10.131.144.28
# xad_auto_test_disc_site:          Include: 10.131.144.21 , 10.131.146.11                                          Exclude: NA

# Both Vulnerability sites have asset strng configured "xad_test_disc_asset_group" in Asset Group (IPs: 10.131.146.65  .85  .87  .88  .89  .105  .106  .107  .109  .77  .83  .93)

*** Settings ***
Library     auc.generic.api_call.ExecuteAPICall
Library     auc.generic.log_check.ExecuteLogCheck
Library     auc.generic.parsers.Parsers

*** Variables ***
# API URL Details
${MW_TRIGGER_VSCAN_URL}     http://10.100.249.88:8000/api/v1/service/vulnerability/scan

# REGEX Details
${VSCAN_LOG REGEX}         Inside: process_vulnerability_message((.|\n)*?) Exit: process_vulnerability_message
${VSCAN_SUCCESS_REGEX}     Scan ID for Vulnerability scan for VM
${VSCAN_ERROR_REGEX}       Error: VUL_00(\d)

*** Test Cases ***
################################################################################################################################################
Test VOCS-T136 Trigger the Vulnerability scan when asset not configured on tagged Vulnerability scan site but configured on tagged Discovery site
#################################################################################################################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "7fd98776-4e8b-49fc-bfc8-fe0464c7321e", "VirtualMachineIPAddress": "10.131.146.65"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Add Wait Time for the request to go through
    sleep   5

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_SUCCESS_REGEX}
    Should be equal as strings   ${STATUSCODE}   PASS

###########################################################################
Test VOCS-T137 Trigger Vulnerability Scan for VM not configured in any site
###########################################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "7fd98776-4e8b-49fc-bfc8-fe0464c7321e", "VirtualMachineIPAddress": "10.100.249.40"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Add Wait Time for the request to go through
    sleep   5

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_ERROR_REGEX}
    Should be equal as strings   ${STATUSCODE}   FAIL

##########################################################
Test VOCS-T67 Trigger Vulnerability Scan for Invalid VM IP
##########################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "7fd98776-4e8b-49fc-bfc8-fe0464c7321e", "VirtualMachineIPAddress": "1000.100.249.000"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   FAIL

#############################################################
Test VOCS-T68 Trigger Vulnerability Scan for Invalid TenantID
#############################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "0007fd98776-4e8b-49fc-bfc8-fe0464c7321e", "VirtualMachineIPAddress": "10.131.146.87"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   FAIL

#################################################################################
Test VOCS-T143 Trigger Vulnerability Scan for VM configured in both Include and Exclude list of Vulnerability scan site
#################################################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "59deef16-a618-4ae7-8fed-b3c9050092aa", "VirtualMachineIPAddress": "10.131.144.28"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Add Wait Time for the request to go through
    sleep   5

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_ERROR_REGEX}
    Should be equal as strings   ${STATUSCODE}   FAIL

#################################################################################
Test VOCS-T141 Trigger Vulnerability Scan for VM excluded from vulnerability site
#################################################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "7fd98776-4e8b-49fc-bfc8-fe0464c7321e", "VirtualMachineIPAddress": "10.131.146.89"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Add Wait Time for the request to go through
    sleep   5

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_ERROR_REGEX}
    Should be equal as strings   ${STATUSCODE}   FAIL

#############################################################################
Test VOCS-T142 Trigger Vulnerability Scan for VM excluded from discovery site
#############################################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "7fd98776-4e8b-49fc-bfc8-fe0464c7321e", "VirtualMachineIPAddress": "10.131.146.65"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Add Wait Time for the request to go through
    sleep   5

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_SUCCESS_REGEX}
    Should be equal as strings   ${STATUSCODE}   PASS


#################################################################################
Test VOCS-T140 Trigger Vulnerability Scan for VM configured in both Vulnerability and Discovery scan site
#################################################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "7fd98776-4e8b-49fc-bfc8-fe0464c7321e", "VirtualMachineIPAddress": "10.131.146.77"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Add Wait Time for the request to go through
    sleep   5

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_SUCCESS_REGEX}
    Should be equal as strings   ${STATUSCODE}   PASS

###################################################################################
Test VOCS-T145 Trigger Vulnerability Scan for VM in IP range in Discovery scan site
###################################################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "7fd98776-4e8b-49fc-bfc8-fe0464c7321e", "VirtualMachineIPAddress": "10.131.146.105"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Add Wait Time for the request to go through
    sleep   5

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_SUCCESS_REGEX}
    Should be equal as strings   ${STATUSCODE}   PASS

#######################################################################################
Test VOCS-T147 Trigger Vulnerability Scan for VM in IP range in Vulnerability scan site
#######################################################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "59deef16-a618-4ae7-8fed-b3c9050092aa", "VirtualMachineIPAddress": "10.131.146.101"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Add Wait Time for the request to go through
    sleep   5

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_SUCCESS_REGEX}
    Should be equal as strings   ${STATUSCODE}   PASS

#######################################################################################
Test VOCS-T65 Trigger Vulnerability Scan for VM configured in Vulnerability site
#######################################################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "59deef16-a618-4ae7-8fed-b3c9050092aa", "VirtualMachineIPAddress": "10.131.146.89"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Add Wait Time for the request to go through
    sleep   5

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_SUCCESS_REGEX}
    Should be equal as strings   ${STATUSCODE}   PASS

#######################################################################################
Test VOCS-T48 Trigger Vulnerability Scan for VM configured in both IP range Vulnerability and Discovery site
#######################################################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "59deef16-a618-4ae7-8fed-b3c9050092aa", "VirtualMachineIPAddress": "10.131.146.103"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Add Wait Time for the request to go through
    sleep   5

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_SUCCESS_REGEX}
    Should be equal as strings   ${STATUSCODE}   PASS

##############################################################################
Test VOCS-T153 Trigger the Vulnerability scan on site having more than 1 tags
##############################################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "59deef16-a618-4ae7-8fed-b3c9050092aa", "VirtualMachineIPAddress": "10.131.146.100"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Add Wait Time for the request to go through
    sleep   5

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_SUCCESS_REGEX}
    Should be equal as strings   ${STATUSCODE}   PASS
    sleep   30

    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "ca4a510a-d37c-43fa-822f-e5313a2aece1", "VirtualMachineIPAddress": "10.131.146.120"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Add Wait Time for the request to go through
    sleep   5

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_SUCCESS_REGEX}
    Should be equal as strings   ${STATUSCODE}   PASS


#######################################################################################
Test VOCS-T150 Re-trigger the Vulnerability scan on VM while scan is already in progress
#######################################################################################
    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6

    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "7fd98776-4e8b-49fc-bfc8-fe0464c7321e", "VirtualMachineIPAddress": "10.131.144.9"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_SUCCESS_REGEX}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Get Start Time
    ${TEST_START_TIME} =    current time utc
    sleep   6
    # Trigger Vulnerability scan from Middleware
    ${APIRESPONSE} =   api call    url=${MW_TRIGGER_VSCAN_URL}   auth=basic    usr=middleware    pwd=Password1    rtype=POST     body={"TenantID": "7fd98776-4e8b-49fc-bfc8-fe0464c7321e", "VirtualMachineIPAddress": "10.131.144.9"}
    ${STATUSCODE} =   parse api status   ${APIRESPONSE}
    Should be equal as strings   ${STATUSCODE}   PASS

    # Post-scan check: Check Worker logs
    ${LOG} =   get log    service=worker    start_time=${TEST_START_TIME}    exit_pattern=${VSCAN_LOG REGEX}
    ${STATUSCODE} =   parse log   ${LOG}    regex=${VSCAN_ERROR_REGEX}
    Should be equal as strings   ${STATUSCODE}   FAIL